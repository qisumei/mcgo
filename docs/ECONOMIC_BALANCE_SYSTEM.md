# 经济平衡系统文档

## 概述

经济平衡系统是MC:GO模组的核心功能，旨在确保游戏的公平性和竞技平衡。该系统通过多个维度控制经济流动，防止经济失衡导致的游戏体验下降。

## 核心处理时机

每回合开始后立即触发装备slot处理与经济状态初始化逻辑，确保初始状态公平一致。

## 一、装备槽位管理系统

### 1.1 基础清空与保留规则

**背包清空规则：**
- 玩家背包（非工具栏slot）全部清空
- 禁止"护甲塞满背包"等冗余堆积
- 从物品维度切断经济滥用渠道

**工具栏保留规则：**

仅保留工具栏特定slot的物品：

| Slot编号 | UI显示 | 用途 | 保留规则 |
|---------|--------|------|---------|
| Slot 0 (1) | 主武器 | 长枪/步枪/AWP | 保留，弹夹状态继承 |
| Slot 1 (2) | 副武器 | 手枪/冲锋枪 | 保留，弹夹状态继承 |
| Slot 2 (3) | 近战武器 | 刀 | 保留 |
| Slot 3 (4) | **强制清空** | - | 杜绝高价值物品囤积 |
| Slot 4 (5) | 投掷物1 | 手雷/闪光弹等 | 仅保留未使用的 |
| Slot 5 (6) | 投掷物2 | 烟雾弹等 | 仅保留未使用的 |
| Slot 6-8 (7-9) | 清空 | - | 清空 |

### 1.2 长枪限制检测

**目标：** 确保最多仅存在1把长枪，从装备类型维度避免经济投入与实战收益失衡

**检测逻辑：**
- 检测范围：Slot 0（主武器）和 Slot 1（副武器）
- 长枪定义：步枪（rifles）、重型武器（heavies）、AWP类狙击枪
- 检测方式：基于物品ID或预设tag（如"tag_long_gun"）
- 处理方式：如果两个slot都是长枪，清空副武器slot

**特殊处理：**
- 子弹类物品不参与检测（仅后台记录）
- 近战武器自动去重，仅保留第一把

### 1.3 武器瞄具规则

**基础瞄具：**
- 所有购买的枪械（主武器、副武器）默认自带1个基础瞄具
- 基础瞄具类型：机械瞄具（不可更换、拆卸或升级）
- 确保基础瞄准功能一致性

**禁止额外瞄具：**
- 禁止购买或装配任何额外瞄具配件（如红点、倍镜）
- 避免"瞄具差异"导致的对抗不公平
- 保持"基础瞄具 = 统一起点"

## 二、投掷物消耗与限购规则

### 2.1 消耗逻辑

- 投掷物一旦投掷即视为消耗，本回合内不可恢复
- 回合开始仅保留未使用的投掷物
- 已消耗的slot自动清空
- 确保"投掷物价值 = 单次使用成本"

### 2.2 限购与定价

**限购规则：**
- 每回合购买阶段，每种投掷物（手雷/闪光弹/烟雾弹等）仅能购买1个
- 按类型区分，不同类型可各购买1个

**定价平衡：**
- 定价与战术价值严格挂钩
- 烟雾弹：战术价值高，定价略高
- 手雷：伤害稳定，定价中等
- 闪光弹：辅助功能，定价适中
- 避免"低价多投掷"碾压战术

## 三、整体经济平衡核心机制

### 3.1 初始资金统一化

**游戏开局：**
- 所有玩家初始资金：10,000 金币
- 消除"阵营/角色差异"导致的起点不公

**每回合开始：**
- 基础资金重置为：5,000 金币
- 叠加"上回合任务奖励"
- 不叠加基础资金，避免资金滚雪球

### 3.2 收益标准化

**击杀奖励：**
- 统一固定值：300 金币/击杀
- 不区分"爆头/普通击杀"
- 避免"高难度操作 = 超额收益"打破平衡

**任务奖励：**
| 任务类型 | 奖励金额 | 说明 |
|---------|---------|------|
| CT阵营解C4 | 800 金币 | 拆除炸弹奖励 |
| T阵营安C4 | 800 金币 | 安放炸弹奖励 |
| 回合胜利 | 1,000 金币 | 阵营全员奖励 |

**奖励原则：**
- 奖励值与"对回合结果的影响权重"匹配
- 避免"杀人数 > 任务"的经济导向
- 无"连杀/助攻"额外奖励，杜绝"优势方滚雪球"

### 3.3 消耗与定价平衡

**武器定价原则：**
- 严格遵循"强度 = 成本"原则
- 长枪：威力大，定价高
- 手枪：便携，威力低，定价低
- 同类武器性能差异 ≤ 10%，定价差异 ≤ 15%
- 基础瞄具为枪械自带，不额外加价

**枪械初始状态：**
- 购买的枪械弹夹为空
- 玩家需在购买阶段同步购买对应子弹
- 子弹定价与武器匹配（长枪子弹单价 > 手枪子弹）
- 单回合子弹购买上限 = 武器弹夹容量 × 4
- 强制"枪械 + 子弹"捆绑决策

**限购机制：**
- 所有武器（含手枪）单回合限购1把
- 护甲/头盔等防御道具单回合限购1套
- 被摧毁/消耗后需重新购买
- 确保"经济投入与生存时长"正相关

### 3.4 惩罚机制对等化

**死亡惩罚：**
- 所有玩家死亡后损失固定比例资金：20%
- 不分阵营/角色
- 避免"死亡成本差异"导致的打法失衡

**失败惩罚：**
- 回合失败方全员仅获得基础资金
- 无胜利奖励
- 不额外扣钱，防止"连败方经济崩溃"

### 3.5 动态平衡兜底

**触发条件：**
- 某一阵营连续3回合胜利

**调整机制：**
- 第4回合开始：
  - 胜利方基础资金降低10%
  - 失败方基础资金提高10%
- 避免"绝对经济压制"无法翻盘

**重置条件：**
- 换边时重置连胜计数
- 失败方获胜后重置连胜计数

## 四、C4爆炸与购买机制

### 4.1 C4爆炸处理

**CT阵营惩罚：**
- C4爆炸时，CT未死亡玩家装备全清空
- 需重新购买所有装备
- 直接关联经济消耗
- 强化"C4防守失败的经济代价"

### 4.2 购买时间延长

**购买阶段时长：**
- 默认：90秒（可配置）
- 范围：5-120秒
- 目的：确保玩家有充足时间进行经济决策

**决策窗口：**
- 评估当前资金状况
- 规划武器+子弹购买
- 考虑队友配置
- 制定战术策略

## 五、命令安全

### 5.1 观战命令限制

**命令：** `/cs watch <比赛名称>`

**权限要求：**
- 仅管理员可使用（权限级别2）
- 普通玩家调用时提示"无权限"并拒绝执行

**安全目的：**
- 防止通过观察者模式获取信息
- 避免影响经济决策公平性

## 六、实现类说明

### 6.1 InventorySlotManager

装备槽位管理器，负责：
- 回合开始时清空和初始化玩家装备
- 长枪限制检测和处理
- 近战武器去重
- Slot 4强制清空

### 6.2 EconomicBalanceManager

经济平衡管理器，负责：
- 初始资金设置（游戏开局10000，回合5000）
- 标准化奖励发放（击杀300、任务800、胜利1000）
- 死亡惩罚处理（20%资金损失）
- 动态平衡机制（连续3胜后触发±10%调整）
- 连胜计数跟踪

### 6.3 PurchaseLimitManager

购买限制管理器，负责：
- 武器限购检测（单回合1把）
- 护甲限购检测（单回合1套）
- 投掷物限购检测（每种1个）
- 子弹限购检测（弹夹容量×4）
- 购买记录追踪和重置

## 七、配置选项

在 `config/qiscsgo-server.toml` 中配置：

```toml
[Game Rules]
# 购买阶段持续时间（秒）
# 推荐: 90秒以确保充足决策时间
buyPhaseSeconds = 90

[Economy]
# 手枪局起始资金（保持兼容性）
pistolRoundStartingMoney = 800

# 注：经济平衡系统使用固定常量：
# - 游戏开局: 10000
# - 回合基础: 5000
# - 击杀奖励: 300
# - C4任务: 800
# - 回合胜利: 1000
# - 死亡惩罚: 20%
# - 动态平衡: ±10%
```

## 八、使用示例

### 游戏流程中的经济变化

**场景1：游戏开局**
```
玩家A加入比赛 -> 获得10,000初始资金
```

**场景2：第一回合（手枪局）**
```
回合开始 -> 设置为800手枪局资金
购买阶段 -> 玩家购买手枪（200）+ 子弹（100）
战斗阶段 -> 击杀敌人获得300奖励
回合结束 -> CT获胜，全员获得1000奖励
```

**场景3：第二回合**
```
回合开始 -> 基础资金5000 + 上回合奖励
死亡 -> 损失20%当前资金
装备清空 -> Slot4强制清空，保留主副武器
长枪检测 -> 双持长枪，清空副武器
```

**场景4：连续3回合胜利**
```
CT连续3回合胜利 -> 触发动态平衡
第4回合 -> CT方资金-10%，T方资金+10%
```

## 九、平衡性测试建议

1. **经济曲线测试：** 记录10局游戏的资金变化曲线，确保无滚雪球现象
2. **武器选择测试：** 统计各类武器的购买率和击杀贡献，确保平衡
3. **动态平衡测试：** 验证连续3胜后的资金调整是否有效
4. **死亡惩罚测试：** 确认20%惩罚不会导致经济崩溃

## 十、未来扩展

- [ ] 排行榜功能优化（经济与战斗数据可视化）
- [ ] 每回合平均消费统计
- [ ] 资金利用率计算（击杀数/花费金币）
- [ ] 枪械+子弹同步购买率统计
- [ ] 瞄具使用有效击杀数统计
- [ ] 实时/历史榜单支持
- [ ] 分类排名及数据对比
