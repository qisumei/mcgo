# ADR-0001: 多模块架构迁移

## 状态

**已接受** - 2024-10

## 上下文

### 当前问题

MCGO 项目目前是一个单体结构，所有代码都在 `src/main/java` 下，存在以下问题：

1. **模块耦合度高**: Match、C4Manager 等组件之间存在双向依赖
2. **职责边界不清**: 配置、业务逻辑、持久化混在一起
3. **平台耦合严重**: 核心业务逻辑与 NeoForge/Minecraft 平台紧密耦合
4. **测试困难**: 由于平台依赖，无法进行纯 Java 单元测试
5. **可维护性差**: 修改一个模块可能影响多个其他模块
6. **扩展性受限**: 难以支持多平台或添加新功能

### 业务需求

- 降低维护成本
- 提高代码质量
- 支持未来的平台扩展
- 提升团队开发效率
- 增强系统可测试性

## 决策

采用**多模块 Gradle 架构**，将项目拆分为以下模块：

### 核心模块

1. **mcgo-bom**: 版本管理（Bill of Materials）
2. **mcgo-build-logic**: 构建约定插件
3. **mcgo-api**: 公共 API、接口、DTO
4. **mcgo-core**: 纯 Java 核心业务逻辑
5. **mcgo-economy**: 经济系统子域
6. **mcgo-network**: 网络通信抽象
7. **mcgo-data**: 数据持久化适配器

### 平台与端侧模块

8. **mcgo-platform-neoforge**: NeoForge 平台绑定层
9. **mcgo-client**: 客户端专属逻辑
10. **mcgo-server**: 服务端专属逻辑
11. **mcgo-integration-qiscsgo**: 外部集成适配
12. **mcgo-test**: 端到端测试

### 架构模式

- **端口-适配器（Hexagonal Architecture）**: 核心业务逻辑定义端口（接口），外层提供适配器（实现）
- **依赖倒置原则**: 高层模块不依赖低层模块，都依赖抽象
- **单一职责原则**: 每个模块有明确的单一职责
- **分层架构**: API → Core → Domain Modules → Platform → Client/Server

### 依赖关系

```
Platform Layer (mcgo-platform-neoforge)
    ↓
Domain Modules (economy, network, data, client, server)
    ↓
Core Layer (mcgo-core)
    ↓
API Layer (mcgo-api)
    ↓
BOM (mcgo-bom)
```

### 迁移策略

采用**渐进式迁移**，分6个阶段：

1. **阶段一**: 建立骨架（不移动代码）
2. **阶段二**: 迁移核心业务逻辑
3. **阶段三**: 抽取网络层
4. **阶段四**: 分离数据层
5. **阶段五**: 客户端/服务端分离
6. **阶段六**: 完善测试和清理

每个阶段保持功能等价，可独立验证和回滚。

## 后果

### 正面影响

#### 可维护性提升

- ✅ 清晰的模块边界，修改影响范围可控
- ✅ 代码职责明确，易于理解和维护
- ✅ 依赖关系清晰，避免循环依赖

#### 可测试性增强

- ✅ 核心模块纯 Java，可进行单元测试
- ✅ 平台依赖隔离，降低集成测试复杂度
- ✅ 支持测试夹具和 Mock

#### 可扩展性改善

- ✅ 易于添加新功能模块
- ✅ 支持多平台扩展（未来可支持 Fabric 等）
- ✅ 外部集成通过适配器模式

#### 开发效率提高

- ✅ 模块可独立开发和测试
- ✅ 并行开发不同模块
- ✅ IDE 支持更好（模块化项目）

#### 质量保障

- ✅ 统一的构建约定
- ✅ 版本集中管理
- ✅ 质量门禁易于实施

### 负面影响与缓解

#### 学习成本

- ⚠️ **影响**: 团队需要学习新的架构模式
- ✅ **缓解**: 提供完整文档（ARCHITECTURE.md, CONTRIBUTING.md）

#### 构建复杂度

- ⚠️ **影响**: 多模块构建比单模块复杂
- ✅ **缓解**: 
  - 使用 Gradle 构建约定插件
  - 提供清晰的构建脚本
  - 文档化构建流程

#### 初期重构成本

- ⚠️ **影响**: 需要投入时间进行代码迁移
- ✅ **缓解**:
  - 采用渐进式迁移
  - 每阶段保持功能等价
  - 可随时回滚

#### 过度工程风险

- ⚠️ **影响**: 可能引入不必要的复杂性
- ✅ **缓解**:
  - 遵循"最小必要"原则
  - 每个模块有明确目的
  - 定期审查架构决策

### 性能影响

- ⚙️ **编译时间**: 可能略有增加，但可并行编译
- ⚙️ **运行时**: 无影响（最终还是打包为单个 JAR）
- ⚙️ **开发体验**: IDE 模块加载更快

## 备选方案

### 备选方案 1: 保持单体结构

**优点**:
- 无需迁移成本
- 团队熟悉

**缺点**:
- 维护成本持续增加
- 技术债累积
- 扩展性受限

**为什么不选**: 长期来看不可持续

### 备选方案 2: 微服务架构

**优点**:
- 完全独立部署
- 技术栈可异构

**缺点**:
- 过度工程（对 Minecraft mod 而言）
- 运维复杂度高
- 网络延迟影响游戏体验

**为什么不选**: 对游戏 mod 来说过于复杂

### 备选方案 3: 仅重构代码结构（包级别）

**优点**:
- 实施成本低
- 改动范围小

**缺点**:
- 无法强制模块边界
- 依赖关系难以管理
- 可测试性改善有限

**为什么不选**: 改善效果不够显著

## 实施计划

详见 [REFACTORING_PLAN.md](../REFACTORING_PLAN.md)

### 时间估算

- 阶段一（骨架）: 2-3 天 ✅ **已完成**
- 阶段二（核心迁移）: 3-5 天
- 阶段三（网络层）: 2-3 天
- 阶段四（数据层）: 2-3 天
- 阶段五（客户端/服务端）: 2-3 天
- 阶段六（测试完善）: 3-5 天

**总计**: 约 3-4 周

### 风险控制

1. **功能回归风险**
   - 每阶段验证功能等价
   - 保留端到端测试
   - Git 标签标记每个稳定阶段

2. **构建失败风险**
   - 本地验证后再提交
   - CI 自动检查
   - 保持向后兼容

3. **团队协作风险**
   - 分支保护
   - Code Review 必须
   - 文档同步更新

## 参考资源

- [Clean Architecture by Robert C. Martin](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html)
- [Hexagonal Architecture](https://alistair.cockburn.us/hexagonal-architecture/)
- [Gradle Multi-Project Builds](https://docs.gradle.org/current/userguide/multi_project_builds.html)
- [Domain-Driven Design](https://martinfowler.com/tags/domain%20driven%20design.html)

## 审查与批准

- **提出者**: MCGO Team
- **审查者**: 项目维护者
- **批准日期**: 2024-10
- **决策生效**: 立即

---

**下一步行动**: 开始阶段二 - 核心逻辑迁移
